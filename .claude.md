# Commander.ai - Claude Code Quick Sync

**Last Updated**: 2026-02-05
**Status**: v1.3 - Chat Agent Tool Execution Fix, JWT Authentication Complete, Production-Ready

---

## üéØ Project Overview

**commander.ai** is a multi-agent AI system enabling natural language delegation to specialized agents through @mentions and conversational commands. Built with LangGraph orchestration, dual-layer memory (Redis STM + PostgreSQL/Qdrant LTM), and cache-first web search architecture.

**Current Stage**: Core functionality complete with 7 specialized agents, DocumentStore singleton pattern, TavilyToolset cache-first web search, REST/WebSocket API, and AWS CDK deployment ready.

---

## üèóÔ∏è Architecture Quick Reference

### **Technology Stack**
- **Backend**: Python 3.12+, FastAPI, LangGraph, LangChain
- **Frontend**: Next.js 14+, TypeScript, Tailwind CSS, shadcn/ui
- **Memory**: Redis (STM), PostgreSQL (metadata), Qdrant (vector embeddings)
- **LLM**: OpenAI GPT-4o-mini (agents), ada-002 (embeddings)
- **Web Search**: Tavily API with cache-first pattern (24h general, 1h news TTL)

### **7 Specialized Agents**

| Agent | Nickname | Role | Key Capability |
|-------|----------|------|----------------|
| Agent A | @bob | Research Specialist | Web search + synthesis |
| Agent B | @sue | Compliance Specialist | Regulatory analysis |
| Agent C | @rex | Data Analyst | Statistical analysis |
| Agent D | @alice | Document Manager | Web search + storage (15-node workflow) |
| Agent E | @ada | Problem Solver | Technical troubleshooting |
| Agent F | @brian | Forensic Specialist | Incident investigation |
| Agent G | @chat | Interactive Chat | Conversational assistance |
| Parent Agent | @leo | Orchestrator | Multi-agent coordination |

---

## ‚úÖ Completed & Working

### **Phase 1-5: TAVILYFIX - Unified Web Search** ‚úÖ
- **TavilyToolset** with cache-first pattern (24h general, 1h news)
- **DocumentStore singleton** pattern via `get_document_store()`
- **Cache collections**: `web_cache_{user_id}` with semantic similarity
- **Rate limiting**: 60 calls/min with exponential backoff retry
- **alice's 15-node workflow**: Parse ‚Üí Validate ‚Üí Fetch Web ‚Üí Chunk ‚Üí Embed ‚Üí Store ‚Üí Format Results
- **Deduplication**: Content hash prevents duplicate storage
- **Error handling**: Graceful fallback to LLM knowledge on API failures

### **Testing Infrastructure** ‚úÖ
- **Unit tests**: `tests/` with shared fixtures in `conftest.py`
- **API tests**: REST endpoints and WebSocket real-time updates
- **Integration tests**: End-to-end workflows, cache lifecycle
- **Test coverage tracking**: See `TESTING.md` for patterns and best practices

### **AWS Deployment Architecture** ‚úÖ
- **5 CDK Stacks**: Network, Database, Cache, Backend, Frontend
- **Services**: ECS Fargate, RDS PostgreSQL 16 + pgvector, ElastiCache Redis, Qdrant on ECS
- **Security**: VPC isolation, encryption at rest/in transit, IAM least privilege
- **Cost**: ~$490/month prod, ~$150/month dev
- **CI/CD**: GitHub Actions pipelines ready
- **Details**: See `CLOUDDEPLOY.md`

### **JWT Authentication System** ‚úÖ
- **Production-ready auth**: User registration, login, token refresh
- **JWT tokens**: Access tokens (1h), refresh tokens (7 days)
- **Password security**: bcrypt hashing with salt
- **Protected endpoints**: All `/api/tasks`, `/api/commands`, WebSocket require auth
- **User isolation**: Users can only access their own resources
- **MVP dev bypass**: `user_id=00000000-0000-0000-0000-000000000001` query param for development
- **Test coverage**: 26/27 tests passing (94% coverage) - `tests/auth/`
- **Frontend integration**: All API calls include MVP user bypass for seamless dev experience

**Key Files:**
- `backend/auth/` - Models, security, routes, dependencies
- `backend/api/routes/` - Protected endpoints
- `tests/auth/` - Comprehensive auth test suite

### **Chat Agent (@chat) Tool Execution** ‚úÖ
- **Web search integration**: Agentic loop executes tool calls from LLM
- **Tool execution flow**: LLM decides to use tools ‚Üí Code executes ‚Üí Results fed back ‚Üí Final response
- **Max iterations**: 5 iterations to prevent infinite loops
- **Error handling**: Graceful fallback on tool failures
- **Metrics tracking**: Each LLM call and tool execution tracked separately
- **Auto-focus UI**: Input field automatically focuses after assistant responds
- **Test coverage**: 20/20 tests passing (100%) - `tests/agents/test_agent_g_chat.py`

**Before Fix:**
- User: "Search for latest Python news"
- Response: "assistant" (empty/minimal text)

**After Fix:**
- User: "Search for latest Python news"
- LLM generates tool_call ‚Üí web_search executes ‚Üí Results returned ‚Üí Final answer with search results

**Key Files:**
- `backend/agents/specialized/agent_g/llm_chat.py` - Agentic loop implementation
- `frontend/components/chat/chat-modal.tsx` - Auto-focus after response
- `tests/agents/test_agent_g_chat.py` - Comprehensive tool execution tests

---

## üîë Critical Patterns

### **1. DocumentStore Singleton Pattern** üö®
**ALWAYS use singleton - NEVER create instances directly**

```python
# ‚úÖ CORRECT - Use singleton
from backend.core.dependencies import get_document_store
doc_store = await get_document_store()
# ... use (no disconnect needed)

# ‚ùå WRONG - Creates new connection pool
doc_store = DocumentStore()
await doc_store.connect()
# ... use
await doc_store.disconnect()  # Breaks singleton!
```

**Why**: Prevents connection pool exhaustion. alice's nodes previously created 6 separate instances, causing "NoneType has no attribute 'upsert'" errors.

### **2. Web Search via TavilyToolset**
**Cache-first pattern for all web searches**

```python
from backend.tools.web_search.tavily_toolset import TavilyToolset
from backend.core.dependencies import get_document_store

tavily = TavilyToolset(
    api_key=get_settings().tavily_api_key,
    document_store=await get_document_store(),
    enable_caching=True
)

result = await tavily.search(
    query="search query",
    user_id=user_id,
    use_cache=True,  # Check cache first
    topic="general"  # or "news" (1h TTL)
)
```

**Cache Behavior**:
- First query: Cache miss ‚Üí Tavily API ‚Üí Store in `web_cache_{user_id}`
- Second query: Cache hit ‚Üí Return from Qdrant (< 100ms)
- After TTL: Stale ‚Üí Refresh from API

### **3. Agent Integration with Web Search**

**Decision Matrix**:
- **bob (research)**: `tavily.search()` ‚Üí ephemeral results (relies on cache)
- **alice (storage)**: `tavily.search()` ‚Üí chunk ‚Üí embed ‚Üí store in user collections
- **chat**: `tavily.search()` via tool binding + agentic loop ‚Üí conversational responses with search results

**Chat Agent Tool Execution Pattern:**
```python
# Agentic loop in llm_generate_chat_response()
for iteration in range(MAX_TOOL_ITERATIONS):
    response = await llm.ainvoke(messages)

    if not response.tool_calls:
        return response.content  # Final answer

    # Execute tools
    for tool_call in response.tool_calls:
        result = await web_search_tool.coroutine(tool_call["args"]["query"])
        messages.append(ToolMessage(content=result, tool_call_id=tool_call["id"]))

    # Loop continues with tool results in context
```

### **4. Error Handling**
**NO silent failures - always log and gracefully degrade**

```python
# ‚úÖ CORRECT
from backend.tools.web_search.exceptions import TavilyRateLimitError, TavilyError

try:
    result = await tavily.search(query, user_id)
except TavilyRateLimitError:
    logger.warning("Rate limit hit, using cache-only")
    result = await tavily._check_cache(query, user_id)
except TavilyError as e:
    logger.error(f"Web search failed: {e}")
    # Return error message, don't hide it

# ‚ùå WRONG
except Exception as e:
    print(f"Failed: {e}")  # Silent failure!
```

---

## üìä alice's Web Search Workflow

**15-Node LangGraph Pipeline** (agent_d):

1. **parse_input_node** ‚Üí Determine action type (search_web, upload_file, search_collection)
2. **validate_input_node** ‚Üí Check collection exists, validate search query
3. **fetch_web_node** ‚Üí TavilyToolset.search() with cache-first
4. **chunk_documents_node** ‚Üí Split into semantic chunks
5. **embed_chunks_node** ‚Üí Generate ada-002 embeddings
6. **store_chunks_node** ‚Üí Upsert to Qdrant with deduplication
7. **format_response_node** ‚Üí Show formatted results with titles, URLs, scores
8. ... (routing, error handling, progress updates)

**User Experience**:
- Input: `@alice search web for "PayPal company news that is negative" into PayPal`
- Output:
  ```
  ‚úì Loaded 'web_search_PayPal_company_news_that_is_negative' into collection 'paypal' (18 chunks).

  **Search Results:**
  1. **PayPal faces regulatory scrutiny** (relevance: 0.95)
     https://example.com/paypal-news
  ```

---

## üß™ Testing Commands

```bash
# Run all tests
pytest tests/ -v

# Run specific test categories
pytest tests/api/ -v           # REST API tests
pytest tests/agents/ -v        # Agent integration tests
pytest -m integration -v       # Integration tests only
pytest -m slow -v              # Slow/performance tests

# Run with coverage
pytest --cov=backend --cov-report=html
open htmlcov/index.html

# Run specific test
pytest tests/api/test_task_api.py::test_create_task -v
```

**Key Test Files**:
- `tests/conftest.py` - Shared fixtures (user_id, settings, document_store, mock_tavily)
- `tests/api/test_task_api.py` - REST endpoints for task management
- `tests/api/test_websocket.py` - Real-time WebSocket updates
- See `TESTING.md` for templates and best practices

---

## üöÄ Deployment Commands

### **Local Development**
```bash
# Install dependencies
uv sync

# Run backend
python main.py
# OR
uvicorn backend.api:app --reload

# Run frontend (when implemented)
cd frontend && npm run dev

# Database migrations
alembic upgrade head
alembic revision --autogenerate -m "description"
```

### **AWS Production**
```bash
# Prerequisites
npm install -g aws-cdk
pip install aws-cdk-lib constructs

# Deploy all stacks
cd infrastructure/cdk
cdk bootstrap
cdk deploy --all

# Individual stacks
cdk deploy CommanderAiNetworkStack
cdk deploy CommanderAiDatabaseStack
cdk deploy CommanderAiCacheStack
cdk deploy CommanderAiBackendStack
cdk deploy CommanderAiFrontendStack

# See CLOUDDEPLOY.md for full details
```

---

## üé® Image Processing Capabilities

**Tool**: `image_generate_analyze_upscale.py` (Claude Code only, not in git)

**Capabilities**:
1. **Generate**: `python image_generate_analyze_upscale.py generate --prompt "description" --output file.png`
2. **Analyze**: `python image_generate_analyze_upscale.py analyze --image path.png`
3. **Upscale**: `python image_generate_analyze_upscale.py upscale --image input.png --output improved.png`

**Use Cases**:
- Mockups, diagrams, icons, UI concepts
- Screenshot analysis, diagram interpretation
- Image enhancement for documentation

**Integration TODOs** (added to agent graphs):
- ‚úÖ `parent_agent/llm_aggregation.py` (Leo) - Multi-agent workflow visualization
- ‚úÖ `agent_a/llm_research.py` (Bob) - Research trends/timeline visualization
- ‚úÖ `agent_d/nodes.py` (Alice) - Knowledge graph visualization

---

## üìù File Organization

### **Critical Files**
```
backend/
‚îú‚îÄ‚îÄ agents/
‚îÇ   ‚îú‚îÄ‚îÄ parent_agent/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ graph.py              # Leo's multi-agent orchestration
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ llm_aggregation.py    # Result synthesis with TODO for images
‚îÇ   ‚îî‚îÄ‚îÄ specialized/
‚îÇ       ‚îú‚îÄ‚îÄ agent_a/              # @bob (Research)
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ llm_research.py   # Web search + synthesis with TODO
‚îÇ       ‚îú‚îÄ‚îÄ agent_d/              # @alice (DocumentManager)
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ nodes.py          # 15-node workflow with TODO for images
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ graph.py          # LangGraph state machine
‚îÇ       ‚îî‚îÄ‚îÄ agent_g/              # @chat (Interactive)
‚îÇ           ‚îî‚îÄ‚îÄ llm_chat.py       # Chat with tool binding
‚îú‚îÄ‚îÄ tools/web_search/
‚îÇ   ‚îú‚îÄ‚îÄ tavily_toolset.py         # Unified web search with caching
‚îÇ   ‚îî‚îÄ‚îÄ exceptions.py             # TavilyError, TavilyAPIError, etc.
‚îú‚îÄ‚îÄ memory/
‚îÇ   ‚îî‚îÄ‚îÄ document_store.py         # Qdrant + PostgreSQL manager
‚îú‚îÄ‚îÄ core/
‚îÇ   ‚îú‚îÄ‚îÄ dependencies.py           # get_document_store() singleton
‚îÇ   ‚îî‚îÄ‚îÄ config.py                 # Settings with web cache config
‚îî‚îÄ‚îÄ api/
    ‚îú‚îÄ‚îÄ routes/                   # REST endpoints
    ‚îî‚îÄ‚îÄ websockets/               # Real-time updates

tests/
‚îú‚îÄ‚îÄ conftest.py                   # Shared fixtures
‚îú‚îÄ‚îÄ api/                          # REST/WebSocket tests
‚îî‚îÄ‚îÄ agents/                       # Agent integration tests

infrastructure/
‚îú‚îÄ‚îÄ cdk/                          # AWS CDK stacks
‚îî‚îÄ‚îÄ docker/                       # Production Dockerfiles
```

### **Documentation**
- `README.md` - Public-facing overview with agent descriptions and architecture
- `TESTING.md` - Testing philosophy, patterns, templates, best practices
- `CLOUDDEPLOY.md` - AWS CDK deployment guide with 5 stacks
- `.claude.md` - **THIS FILE** - Quick sync for Claude Code

---

## ‚ö†Ô∏è Known Issues & Fixes

### **1. "Collection doesn't exist" on first web search** ‚úÖ FIXED
**Issue**: `web_cache_{user_id}` collection doesn't exist on first search
**Fix**: `TavilyToolset._check_cache()` treats missing collections as cache misses

### **2. "NoneType has no attribute 'upsert'"** ‚úÖ FIXED
**Issue**: alice called `doc_store.disconnect()`, breaking singleton
**Fix**: Removed all `disconnect()` calls from alice's nodes.py (6 occurrences)

### **3. "unknown" file name for web searches** ‚úÖ FIXED
**Issue**: Web searches showed "unknown" instead of query
**Fix**: Use search query as file_name: `f"web_search_{query[:50]}"`

### **4. Missing search results in UI** ‚úÖ FIXED
**Issue**: Users couldn't see what was found
**Fix**: Added formatted results display with titles, URLs, scores

### **5. Chat search returns "assistant" instead of results** ‚úÖ FIXED
**Issue**: @chat web search tool calls never executed, returned empty/minimal text
**Root Cause**: LLM generated tool_calls but code returned `response.content` directly
**Fix**: Implemented agentic loop that:
  - Detects tool_calls in LLM response
  - Executes web_search tool via `web_search_tool.coroutine()`
  - Feeds results back to LLM as ToolMessage
  - Returns final response after LLM processes search results
  - Limits to 5 iterations to prevent infinite loops
**Test Coverage**: 20/20 tests passing, including 5 new tool execution tests

---

## üîÑ Repeatable Startup Pattern

**When starting a new Claude Code session, always:**

1. **Read this file** (`.claude.md`) for project status
2. **Check git status** to see uncommitted changes
3. **Review recent commits** for context: `git log --oneline -5`
4. **Verify backend is running** if testing: `curl http://localhost:8000/health`
5. **Check for active plans**: `ls -la /Users/jb/.claude/plans/`

**Key Questions to Answer**:
- What phase are we in? (Current: v1.1 complete, testing infrastructure established)
- What's currently broken? (Nothing - all systems operational)
- What's the next priority? (User will specify)

**Memory Bank Files** (if they exist):
- `CLAUDE-activeContext.md` - Current session goals
- `CLAUDE-patterns.md` - Code patterns and conventions
- `CLAUDE-decisions.md` - Architecture decisions
- `CLAUDE-troubleshooting.md` - Common issues and solutions

---

## üìö Quick Reference Commands

```bash
# File exploration (FAST - use these!)
fd . -t f                         # List all files recursively
rg "search_term"                  # Search file contents
rg --files | rg "pattern"         # Find files by name

# Git workflow
git status
git log --oneline -10
git diff
git add . && git commit -m "msg" && git push

# Backend
python main.py                    # Run local server
curl http://localhost:8000/health # Check health

# Database
alembic upgrade head              # Run migrations
psql -U commander -d commander    # Connect to PostgreSQL

# Qdrant
curl http://localhost:6333/collections  # List collections
```

---

## üéØ Next Steps (User Will Define)

**Potential Areas**:
- Frontend development (Next.js UI implementation)
- Additional agent capabilities (crawl, extract, map via Tavily)
- Multi-tenant support (user isolation, billing)
- Advanced caching strategies (Redis query cache)
- Monitoring and observability (OpenTelemetry, Datadog)
- Performance optimization (query parallelization)
- Image generation integration into agent workflows (TODOs in place)

**Always ask user for priorities before starting new work.**

---

## üìä Quick Stats

- **Agents**: 7 specialized + 1 parent orchestrator
- **alice's Workflow**: 15 nodes, 8 edges
- **Cache TTL**: 24h general, 1h news
- **Rate Limit**: 60 Tavily calls/min
- **Test Coverage**: Unit + Integration + API tests
- **Deployment**: AWS ECS Fargate ready
- **Database**: PostgreSQL 16 + pgvector, Qdrant 1.7+
- **LLM**: GPT-4o-mini (agents), ada-002 (embeddings)

---

**Last Verified Working**: 2026-02-05 19:00 PST
**Current Git Branch**: main
**Backend URL**: http://localhost:8000
**Frontend URL**: http://localhost:3000 (when implemented)
